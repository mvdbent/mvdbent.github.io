<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        CIS-Script ::
        AppleShare IT — Blog about Apple IT related matters
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="github.com/mvdbent/CIS-Script
This CIS Script is build to report and remediate based on the your organisation score.
While working with CIS Benchmarks (Remediation Scripts and/or Configuration Profiles) I felt this could be done better, faster and easier. The guys from the macOS Security Compliance Project did an amazing job automating the guidance and configuration profiles.
I created custom rules set for CIS Benchmark to integrate with the macOS Security Compliance Project and published CIS-macOS-Security."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/cis-script/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CIS-Script"/>
<meta name="twitter:description" content="This CIS Script is build to report and remediate based on the your organisation score.
While working with CIS Benchmarks (Remediation Scripts and/or Configuration Profiles) I felt this could be done better, faster and easier. The guys from the macOS Security Compliance Project did an amazing job automating the guidance and configuration profiles."/>



<meta property="og:title" content="CIS-Script" />
<meta property="og:description" content="This CIS Script is build to report and remediate based on the your organisation score.
While working with CIS Benchmarks (Remediation Scripts and/or Configuration Profiles) I felt this could be done better, faster and easier. The guys from the macOS Security Compliance Project did an amazing job automating the guidance and configuration profiles." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/cis-script/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-10-03T00:00:00+00:00" /><meta property="og:site_name" content="AppleShare IT" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >AppleShare IT</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/archive">Archive</a></li>
        
      
        
          <li><a href="/post">Blog</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/archive">Archive</a></li>
      
    
      
        <li><a href="/post">Blog</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">CIS-Script</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2021-10-03
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 6 min read</span
        >
      
    </div>

    
      <span class="post-tags">
        
          <a href="/tags/cis/">#CIS</a>&nbsp;
        
          <a href="/tags/benchmark/">#Benchmark</a>&nbsp;
        
          <a href="/tags/reporting/">#Reporting</a>&nbsp;
        
          <a href="/tags/macos/">#macOS</a>&nbsp;
        
          <a href="/tags/security/">#Security</a>&nbsp;
        
          <a href="/tags/jamf-pro/">#Jamf Pro</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      
  <img src="/img/CIS-Script.png"  class="left"  style="border-radius: 8px; height: 300px;"  />


<p><a href="https://github.com/mvdbent/CIS-Script"><strong>github.com/mvdbent/CIS-Script</strong></a></p>
<p><img src="https://img.shields.io/badge/macOS-11-success" alt="GitHub"></p>
<p>This CIS Script is build to report and remediate based on the your organisation score.</p>
<p>While working with CIS Benchmarks (Remediation Scripts and/or Configuration Profiles) I felt this could be done better, faster and easier.
The guys from the <a href="https://github.com/usnistgov/macos_security">macOS Security Compliance Project</a> did an amazing job automating the guidance and configuration profiles.</p>
<p>I created custom rules set for <em><a href="https://downloads.cisecurity.org/#/">CIS Benchmark</a></em> to integrate with the macOS Security Compliance Project and published <a href="https://github.com/mvdbent/CIS-macOS-Security">CIS-macOS-Security</a>.</p>
<p>While working with <strong>CIS Benchmark</strong>, <strong>Script</strong> and <strong>Configuration Profile</strong>, I had the feeling there was missing a overview with compleet reporting, and there for build a read only CIS-Reporting script you can find <a href="https://github.com/mvdbent/CIS-Reporting">here</a></p>
<p>Ended up with seperate tools, creation of the <strong>Documention</strong>, <strong>Configuration Profiles</strong> and <strong>Reporting</strong>. However I still needed an extra script for remediation.</p>
<p>To resolve this I combined the reporting script with remediation with the option to enable remediation or not.</p>
<p>And we need to keep in mind that every year we get a new macOS release and like macOS, Security is a moving target.
Basically things change, and we don&rsquo;t want to edit and maintain an 3000 line script. This will be hard to maintain if a new macOS has released.</p>
<p>For that reason, and for easy maintaining, the CIS-Script is assembled out of a bunch of fragments.</p>

  <img src="/img/folder.jpeg"  class="center"  style="border-radius: 8px; "  />


<p>Here structure of the CIS Script folder, in the root of the folder, there is a symbolic link to the assemble script. The original is in the Utils folder, with some other script you can use. All script that you assamble/create will be stored in the Build folder. For implementation into the jamf pro server there are some resources in the Jamf Folder.</p>
<p>In the Fragments folder. Here you will have the <code>Header.sh</code>, <code>Footer.sh</code> and <code>Version.sh</code> files with all the logic and functions that will be assembled into the script.
In the <strong>OrgScore</strong> Folder are all the separate CIS Benchmark <code>OrgScore*.sh</code>. Every CIS Benchmark orgScore you can test separately if you need to trouble shoot or extend it with the new macOS.</p>
<h3 id="cis-benchmark-orgscore">CIS Benchmark OrgScore</h3>
<p>Let&rsquo;s have a look how the CIS Benchmark OrgScore, looks like.</p>



  <div class="collapsable-code">
    <input id="1" type="checkbox" checked />
    <label for="1">
      <span class="collapsable-code__language">bash</span>
      <span class="collapsable-code__title"><code>OrgScore2_1_1.sh</code></span>
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-bash" ><code>
#!/bin/zsh

script_dir=$(dirname ${0:A})
projectfolder=$(dirname $script_dir)

source ${projectfolder}/Header.sh

CISLevel=&#34;1&#34;
audit=&#34;2.1.1 Turn off Bluetooth, if no paired devices exist (Automated)&#34;
orgScore=&#34;OrgScore2_1_1&#34;
emptyVariables

# Verify organizational score
runAudit
# If organizational score is 1 or true, check status of client
if [[ &#34;${auditResult}&#34; == &#34;1&#34; ]]; then
    method=&#34;Script&#34;
    remediate=&#34;Script - defaults write /Library/Preferences/com.apple.Bluetooth ControllerPowerState -bool false&#34;

    connectable=$(system_profiler SPBluetoothDataType 2&gt;&amp;1 | grep -c &#34;Paired: Yes&#34;)
    bluetoothEnabled=$(defaults read /Library/Preferences/com.apple.Bluetooth ControllerPowerState -bool)
    comment=&#34;Paired Devices: ${connectable}&#34;
    # if [[ &#34;$connectable&#34; == 0 ]] &amp;&amp; [[ &#34;$bluetoothEnabled&#34; == 0 ]]; then
    if [[ &#34;$connectable&#34; -gt 0 ]] &amp;&amp; [[ &#34;$bluetoothEnabled&#34; == 1 ]] || [[ &#34;$connectable&#34; == 0 ]] &amp;&amp; [[ &#34;$bluetoothEnabled&#34; == 0 ]]; then
        result=&#34;Passed&#34;
    else
        result=&#34;Failed&#34;
        comment=&#34;No Paired Devices”

        # Remediation
        if [[ &#34;${remediateResult}&#34; == &#34;enabled&#34; ]]; then
            defaults write /Library/Preferences/com.apple.Bluetooth ControllerPowerState -bool false
            killall -HUP bluetoothd

            # re-check
            connectable=$(system_profiler SPBluetoothDataType 2&gt;&amp;1 | grep -c &#34;Paired: Yes&#34;)
            bluetoothEnabled=$(defaults read /Library/Preferences/com.apple.Bluetooth ControllerPowerState -bool)
            if [[ &#34;$connectable&#34; == 0 ]] &amp;&amp; [[ &#34;$bluetoothEnabled&#34; == 0 ]]; then
                result=&#34;Passed After Remediation&#34;
            else
                result=&#34;Failed After Remediation&#34;
            fi
        fi
    fi
fi
printReport
</code></pre>
  </div>


<p>We <code>runAudit</code> to verify the organizational score. If scored we perform an audit to check the state.
Then Check if <code>remediateResult</code> is enabled, and if enabled we remediate, we perform an audit to check if remediation succeeded and report back so we can read this out in report</p>
<p>To some up what the org score is doing, is <code>Audit</code>, <code>Remediate</code> and <code>report</code>.</p>
<p>For adjustments or testing, you can run every OrgScore seperatly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd /Git/CIS-Script/Fragments/OrgScores
$ sudo ./OrgScore*.sh
</code></pre></div><h3 id="custom-cis-benchmark-orgscore">Custom CIS Benchmark OrgScore</h3>
<p>You can make your own custom <code>OrgScore</code>, which you can include into the CIS-Script.
Make sure that the name of the file is the same as the <code>OrgScore</code> within the script.</p>
<p>Place your custom <code>OrgScore</code> in the <code>Framework/OrgScore</code> folder.</p>
<h3 id="assemble-remediation-script">Assemble Remediation Script</h3>
<p>To assemble all the fragements together in a full Script <code>CISBenchmarkScript.sh</code> which you can use standalone or via an MDM server (like Jamf Pro) you can use the <code>Assemble.sh</code> script.</p>
<p>The <code>Assemble.sh</code> will default build the full Remediation Script <code>CISBenchmarkScript.sh</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./Assemble.sh
</code></pre></div><p>You can create seperate script by running the script with -s [&ndash;separate] option</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./Assemble.sh -s
</code></pre></div><p>With the following command <code>./Assemble.sh -h</code> you can read about the options.</p>



  <div class="collapsable-code">
    <input id="2" type="checkbox" checked />
    <label for="2">
      <span class="collapsable-code__language">bash</span>
      <span class="collapsable-code__title"><code>./Assemble.sh -h</code></span>
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-bash" ><code>
The following options are available:

  -j  --json      Builds Jamf Pro Custom Schema.json file
  -s  --separate  Builds separate CIS Benchmark Script from the fragements
  -h  --help      Displays this message or details on a specific verb

EXAMPLES
  ./Assemble.sh
      Builds CIS Benchmark Script from the fragements

  ./Assemble.sh -j
      Builds Jamf Pro Custom Schema.json file

  ./Assemble.sh -s
      Builds separate CIS Benchmark Script from the fragements
</code></pre>
  </div>


<p>The <code>Assemble.sh</code> script will built the full script in <code>./Build/</code> and the seperate scripts in <code>./Build/Scripts/</code> folder.</p>
<h3 id="cis-benchmark-script">CIS Benchmark Script</h3>
<p>The <code>CISBenchmarkScript.sh</code> Script can be run as a local standalone script, and will preform a read only audit which creates a full report. Location of the report <code>/Library/Security/Reports/</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ./CISBenchmarkScript.sh
</code></pre></div><p>You can create a Full Report by running the script with -f [&ndash;fullreport] option</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ./CISBenchmarkScript.sh -f
</code></pre></div><p>You can enable remediation by running the script with -r [&ndash;remediate] option</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ./CISBenchmarkScript.sh -r
</code></pre></div><p>With the following command <code>./Build/CISBenchmarkScript.sh -h</code> you can read about the options.</p>



  <div class="collapsable-code">
    <input id="3" type="checkbox" checked />
    <label for="3">
      <span class="collapsable-code__language">bash</span>
      <span class="collapsable-code__title"><code>./Build/CISBenchmarkScript.sh -h</code></span>
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-bash" ><code>

The following options are available:

	-f	--fullreport	Print Full Report
	-h	--help			Displays this message or details on a specific verb
	-r	--remediate		Enable Remediation

EXAMPLES
    ./CISBenchmarkScript.sh -f
            Run script to print Full Report

    ./CISBenchmarkScript.sh -r
            Run script with Remediation enabled

    ./CISBenchmarkScript.sh -rf
            Run script with Remediation enabled and print Full Report
</code></pre>
  </div>


<h3 id="implementation-jamf-pro-server">Implementation Jamf Pro Server</h3>
<p>Upload the assembled <code>CISBenchmarkScript.sh</code> Script into the Jamf Pro Server.</p>
<p>Upload the Extension Atrributes into you Jamf Pro Server.
Location <a href="https://github.com/mvdbent/CIS-Script/tree/main/Jamf/EA">Extension Atrributes</a></p>
<h4 id="cis-benchmark-settings-configuration-profile">CIS Benchmark Settings Configuration Profile</h4>
<p>If you use the script via a Jamf Pro you can set the script to create a short or full report, and enable or disable remediation. By using a mobile config we can control and set the organisation scoring and CIS script settings.</p>
<p>For easy creation of the CIS script Configure profile, you can use the <code>Assemble.sh</code> script with -j [&ndash;json] option to generate an <code>JSON Schema manifests</code> from all the fragments in OrgScores folder (including custom OrgScores).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ./CISBenchmarkScript.sh -j
</code></pre></div><p>Create a new computer configuration profile, give the profile a name and add the policy to a categorie, within the Application &amp; Custom Settings payload, upload the just generated Custom Schema.json file, make sure that you check if you upload the just created file, Fill in the preference domain.</p>
<p>Now you can configure what you need the CIS script to do, full or short report, remediation enabled or not, and go through the list and enable/disable the org scores where you need to score on.</p>
<p>After we uploaded the CIS scripts, Configuration profile and Extension Attribute into the Jamf Pro Server, the last thing we need to do is, to create a policy. Create a new policy, choose the preferred trigger, set the preferred frequency, add the CIS Script and don’t forget to scope.</p>
<p>After you scoped the CIS script Configure profile and the Policy with the script to the Target Devices.</p>
<h3 id="you-are-ready-to-get-compliant-and-know-the-state-of-your-devices">You are ready to get compliant and know the state of your devices</h3>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/post/macsysadminscis/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Automating CIS Benchmark Reporting and Remediation | MacSysAdmin 2021</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/post/cis-custom-rules-set-mscp/">
                  <span class="button__text">CIS Custom Rules Set mSCP</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">Powered by Hugo • Made with &#10084; © 2021 • MvdBent</div>
      
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
